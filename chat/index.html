<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           user-scalable=no,
           viewport-fit=cover"/>

<title>Chat Archive</title>

<style>
:root{
  --bg:#000;
  --panel:#0a0a0a;
  --panel2:#111;
  --border:#1f1f1f;
  --text:#eaeaea;
  --muted:#9a9a9a;
  --accent:#3ea6ff;
  --bubble-l:#141414;
  --bubble-r:#0d2a18;
}

*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",
    "PingFang SC","Microsoft YaHei",sans-serif;
  height:100%;
}

/* ===== 关键：header 永远置顶 ===== */
header{
  position:sticky;
  top:0;
  z-index:100;
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-bottom:1px solid var(--border);
  background:var(--panel);
}
header button, header select{
  background:var(--panel2);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
  padding:4px 8px;
}
header .title{font-weight:600}
header .spacer{flex:1}

/* ===== 关键：只让 main 滚动 ===== */
body{
  display:flex;
  flex-direction:column;
}
main{
  flex:1;
  overflow-y:auto;
  padding:10px;
}

/* ===== 会话列表 ===== */
.session-item{
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
  background:var(--panel2);
  cursor:pointer;
}
.session-item:hover{outline:1px solid var(--accent)}
.session-time{color:var(--accent);font-size:13px}
.session-summary{
  margin-top:6px;
  line-height:1.35;
  word-break:break-word;
}

/* ===== 聊天 ===== */
.chat{max-width:900px;margin:0 auto}
.msg{display:flex;margin:10px 0}
.msg.left{justify-content:flex-start}
.msg.right{justify-content:flex-end}
.box{max-width:75%}
@media(max-width:768px){.box{max-width:75vw}}
.name{font-size:12px;color:var(--accent)}
.bubble{
  margin-top:2px;
  padding:10px 12px;
  border-radius:14px;
  line-height:1.35;
  white-space:pre-wrap;
  overflow-wrap:break-word;
}
.left .bubble{background:var(--bubble-l)}
.right .bubble{background:var(--bubble-r)}
.meta{font-size:11px;color:var(--muted);margin-top:4px}
.system{text-align:center;margin:14px 0;font-size:12px}
.system span{
  background:#1a1a1a;
  padding:6px 10px;
  border-radius:999px;
}

/* ===== 日历 ===== */
.calendar{
  position:sticky;
  bottom:0;
  background:var(--panel);
  border-top:1px solid var(--border);
  padding:8px;
}
.cal-header{
  display:flex;
  justify-content:center;
  gap:8px;
}
.cal-header button{
  background:var(--panel2);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
  padding:2px 8px;
}
.cal-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  margin-top:6px;
}
.cal-day{
  padding:6px 0;
  text-align:center;
  border-radius:6px;
  cursor:pointer;
}
.cal-day.has{background:#111}
.cal-day.sel{outline:1px solid var(--accent)}
.cal-day.muted{color:#555;cursor:default}

.hidden{display:none}
</style>
</head>

<body>

<header>
  <button id="backBtn" class="hidden">←</button>
  <div class="title">Chat Archive</div>
  <select id="selfSelect"></select>
  <div class="spacer"></div>
  <input id="file" type="file" accept=".db,.sql,.zip"/>
</header>

<main>
  <div id="listView"></div>
  <div id="chatView" class="chat hidden"></div>
</main>

<div id="calendar" class="calendar"></div>

<script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* ===== JS 逻辑完全保持不变 ===== */
/* 下面这一段与你上一版一致，未做任何功能性改动 */

let SQL, db;
let sessionsByDate = {};
let currentDateKey = null;
let currentSessionId = null;
let selfId = null;

const listView = document.getElementById('listView');
const chatView = document.getElementById('chatView');
const calendarEl = document.getElementById('calendar');
const backBtn = document.getElementById('backBtn');
const selfSelect = document.getElementById('selfSelect');

function ts2d(ts){ if(ts<1e12) ts*=1000; return new Date(ts); }
function pad(n){ return n<10?'0'+n:n; }
function q(sql,p=[]){
  const s=db.prepare(sql); s.bind(p);
  const r=[]; while(s.step()) r.push(s.getAsObject());
  s.free(); return r;
}
function displayName(m){
  return m.sender_group_nickname || m.sender_account_name || `用户${m.sender_id}`;
}
function normalizeContent(t){
  if(!t) return '';
  const m=t.match(/^\[(图片|语音|视频|文件|表情):/);
  return m?`[${m[1]}]`:t;
}

/* SQL dump safe exec */
function runSqlDumpSafely(db, sqlText){
  sqlText = sqlText
    .replace(/--.*$/gm,'')
    .replace(/\/\*[\s\S]*?\*\//g,'');
  const stmts = sqlText.split(/;\s*\n/).map(s=>s.trim()).filter(Boolean);
  db.run('BEGIN;');
  for(const s of stmts){
    const u=s.toUpperCase();
    if(u.startsWith('PRAGMA')||u.startsWith('BEGIN')||u.startsWith('COMMIT')||u.includes('SQLITE_SEQUENCE')) continue;
    try{ db.run(s); }catch{}
  }
  db.run('COMMIT;');
}

/* self */
function initSelf(){
  const saved = localStorage.getItem('selfId');
  const rows = q(`SELECT sender_id, COUNT(*) c FROM message GROUP BY sender_id ORDER BY c DESC`);
  selfSelect.innerHTML='';
  rows.forEach(r=>{
    const o=document.createElement('option');
    o.value=r.sender_id;
    o.textContent=`${r.sender_id} (${r.c})`;
    selfSelect.appendChild(o);
  });
  selfId = saved || rows[0]?.sender_id;
  selfSelect.value = selfId;
  selfSelect.onchange = ()=>{
    selfId=selfSelect.value;
    localStorage.setItem('selfId',selfId);
    if(currentSessionId) renderChatChunked();
  };
}

/* calendar */
let calYear, calMonth;
function renderCalendar(){
  calendarEl.innerHTML='';
  const h=document.createElement('div');
  h.className='cal-header';
  h.innerHTML=`<button id="pm">‹</button><div>${calYear}-${calMonth+1}</div><button id="nm">›</button>`;
  calendarEl.appendChild(h);

  const g=document.createElement('div');
  g.className='cal-grid';
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();

  for(let i=0;i<first;i++){
    const d=document.createElement('div');
    d.className='cal-day muted';
    g.appendChild(d);
  }
  for(let d=1;d<=days;d++){
    const key=`${calYear}-${pad(calMonth+1)}-${pad(d)}`;
    const el=document.createElement('div');
    el.className='cal-day'+(sessionsByDate[key]?' has':'')+(key===currentDateKey?' sel':'');
    el.textContent=d;
    el.onclick=()=>selectDate(key);
    g.appendChild(el);
  }
  calendarEl.appendChild(g);

  document.getElementById('pm').onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--}renderCalendar()};
  document.getElementById('nm').onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++}renderCalendar()};
}

function selectDate(key){
  currentDateKey = key;
  renderCalendar();
  listView.innerHTML='';
  (sessionsByDate[key]||[]).forEach(s=>{
    const d=ts2d(s.start_ts);
    const el=document.createElement('div');
    el.className='session-item';
    el.innerHTML=`<div class="session-time">${pad(d.getHours())}:${pad(d.getMinutes())} (${s.message_count})</div><div class="session-summary">${s.summary||'(no summary)'}</div>`;
    el.onclick=()=>openSession(s.id);
    listView.appendChild(el);
  });
}

/* chat */
function renderChatChunked(){
  chatView.innerHTML='';
  const msgs=q(`SELECT m.* FROM message_context mc JOIN message m ON m.id=mc.message_id WHERE mc.session_id=? ORDER BY m.ts`,[currentSessionId]);
  let i=0, step=50;
  function chunk(){
    const frag=document.createDocumentFragment();
    for(let c=0;c<step && i<msgs.length;c++,i++){
      const m=msgs[i];
      if(m.type===81){
        const d=document.createElement('div');
        d.className='system';
        d.innerHTML=`<span>${m.content}</span>`;
        frag.appendChild(d);
        continue;
      }
      const side=m.sender_id==selfId?'right':'left';
      const t=ts2d(m.ts);
      const wrap=document.createElement('div');
      wrap.className=`msg ${side}`;
      wrap.innerHTML=`<div class="box"><div class="name">${displayName(m)}</div><div class="bubble">${normalizeContent(m.content)}</div><div class="meta">${pad(t.getHours())}:${pad(t.getMinutes())}</div></div>`;
      frag.appendChild(wrap);
    }
    chatView.appendChild(frag);
    if(i<msgs.length) requestAnimationFrame(chunk);
  }
  chunk();
}

function openSession(id){
  currentSessionId=id;
  listView.classList.add('hidden');
  chatView.classList.remove('hidden');
  calendarEl.classList.add('hidden');
  backBtn.classList.remove('hidden');
  renderChatChunked();
}
backBtn.onclick=()=>{
  currentSessionId=null;
  chatView.classList.add('hidden');
  listView.classList.remove('hidden');
  calendarEl.classList.remove('hidden');
  backBtn.classList.add('hidden');
};

/* load */
async function loadFile(file){
  if(!SQL) SQL=await initSqlJs({locateFile:f=>`https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${f}`});
  let buf=null, sqlText=null;
  if(file.name.endsWith('.zip')){
    const zip=await JSZip.loadAsync(file);
    const f=Object.values(zip.files).find(f=>f.name.endsWith('.db')||f.name.endsWith('.sql'));
    if(f.name.endsWith('.sql')) sqlText=await f.async('string');
    else buf=await f.async('uint8array');
  }else if(file.name.endsWith('.sql')){
    sqlText=await file.text();
  }else{
    buf=new Uint8Array(await file.arrayBuffer());
  }

  if(sqlText){
    db=new SQL.Database();
    runSqlDumpSafely(db,sqlText);
  }else{
    db=new SQL.Database(buf);
  }

  initSelf();
  sessionsByDate={};
  q(`SELECT * FROM chat_session`).forEach(s=>{
    const d=ts2d(s.start_ts);
    const key=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    (sessionsByDate[key]??=[]).push(s);
  });

  const now=new Date();
  calYear=now.getFullYear();
  calMonth=now.getMonth();
  currentDateKey=null;
  renderCalendar();
}

document.getElementById('file').onchange=e=>loadFile(e.target.files[0]);
</script>
</body>
</html>
