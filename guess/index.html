<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>çŒœæ­Œåå·¥å…·</title>
  <style>
    :root{
      --bg:#fff;--fg:#000;--card:#f7f7f7;--input-bg:#fff;--input-fg:#000;--accent:#3498db;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#121212;--fg:#e0e0e0;--card:#1e1e1e;--input-bg:#2a2a2a;--input-fg:#e0e0e0;--accent:#5dade2;
      }
    }
    html.light{--bg:#fff!important;--fg:#000!important;--card:#f7f7f7!important;--input-bg:#fff!important;--input-fg:#000!important}
    html.dark {--bg:#121212!important;--fg:#e0e0e0!important;--card:#1e1e1e!important;--input-bg:#2a2a2a!important;--input-fg:#e0e0e0!important}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Arial,Helvetica,sans-serif;line-height:1.5;overflow-x:hidden}
    h1{margin:16px 16px 8px;font-size:1.4rem}
    h2{margin:16px;font-size:1.1rem}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:14px;cursor:pointer}
    button:hover{opacity:.9}
    select{padding:6px;border-radius:4px}
    .container{padding:0 16px 32px}
    .card{background:var(--card);padding:12px;border-radius:8px;margin:8px 0}
    input[type=text],textarea{background:var(--input-bg);color:var(--input-fg);border:1px solid #ccc;border-radius:4px;padding:6px;width:80%;max-width:400px;margin:4px 0}
    textarea{height:120px;resize:vertical}
    pre{white-space:pre-wrap;word-break:break-all;background:var(--input-bg);padding:8px;border-radius:6px;max-height:300px;overflow-y:auto}
    .song-row{display:flex;align-items:center;margin-bottom:4px}
    .song-row input[type=text]{flex:1;margin:0 6px}
    @media(max-width:600px){input[type=text],textarea{width:90%}}
    .theme-toggle{position:fixed;top:10px;right:14px;font-size:20px;background:none;border:none;color:var(--fg)}
    #infoBar{margin:20px 0;padding:8px;text-align:center;font-size:12px;color:var(--fg)}
    #infoBar a{color:var(--accent)}
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
  <div class="container">
    <h1>éŸ³æ¸¸å¼€å­—æ¯å·¥å…·</h1>

    <h2>æ­Œæ›²åˆ—è¡¨</h2>
    <div id="listbox" class="card"></div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <button onclick="add()">ï¼‹ æ·»åŠ æ­Œæ›²</button>
      <button onclick="sort_by_length()">æŒ‰é•¿åº¦æ’åº</button>
      <button onclick="selectAll()">å…¨é€‰/åé€‰</button>
    </div>

    <h2>çŒœæµ‹è¾“å…¥</h2>
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
      <label>guess:</label>
      <input id="guess" type="text" placeholder="è¾“å…¥å­—ç¬¦">
      <button onclick="refresh()">åˆ·æ–°</button>
      <label><input id="sort" type="checkbox" onchange="refresh()"> è‡ªåŠ¨æ’åº</label>
      <label><input id="showLeaf" type="checkbox" onchange="refresh()"> æ˜¾ç¤ºå‰©ä½™éƒ¨ä»¶</label>
    </div>

    <h2>è¾“å‡ºç»“æœ <button onclick="toClipboard()">å¤åˆ¶</button></h2>
    <div class="card"><pre id="output"></pre></div>

    <h2>æ‰¹é‡å¯¼å…¥ / å¯¼å‡º</h2>
    <div class="card" style="display:flex;flex-wrap:wrap;gap:16px">
      <div style="flex:1 1 300px">
        <textarea id="importBox" placeholder="1. æ­Œæ›²åâ€¦â€¦"></textarea><br>
        <button onclick="import_from_text()">å¯¼å…¥ (è¦†ç›–)</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <fieldset style="border:none;padding:0">
          <legend style="font-weight:bold">æ­Œæ›²èŒƒå›´</legend>
          <label><input type="checkbox" class="range-cbx" value="milthm" checked> milthm</label>
          <label><input type="checkbox" class="range-cbx" value="phigros" checked> phigros</label>
          <label><input type="checkbox" class="range-cbx" value="arcaea" checked> arcaea</label>
        </fieldset>
        <label>é™åˆ¶
          <select id="limitType">
            <option value="none">æ— </option>
            <option value="letters">åªåŒ…å«å­—æ¯</option>
            <option value="hanOnly">åªåŒ…å«æ±‰å­—</option>
            <option value="noHan">ä¸åŒ…å«æ±‰å­—</option>
            <option value="noSymbol">ä¸åŒ…å«ç¬¦å·</option>
          </select>
        </label>
        <label>æ•°é‡ <input id="randomCount" type="number" min="1" value="10" style="width:60px"></label>
        <button onclick="addRandomSongs()">éšæœºé€‰æ‹©</button>
      </div>
    </div>
  </div>

  <div id="infoBar">
    ä¿®æ”¹è‡ª<a href="https://compilationfail.github.io/guess.html" target="_blank">çŒœæ­Œåå·¥å…· by compilationfail</a>ï¼Œä½¿ç”¨äº†<a href="https://github.com/secsilm/zi-dataset/tree/master?tab=readme-ov-file" target="_blank">secslimçš„æ±‰å­—åº“</a>
  </div>

  <script>
    /* ===== 1. æ±‰å­—æ•°æ®åº“ ===== */
    const ziDB=new Map(), radicalMap=new Map();
    fetch('./zi-dataset.tsv').then(r=>r.text()).then(txt=>{
      const ls=txt.trim().split(/\r?\n/);
      for(let i=1;i<ls.length;i++){
        const t=ls[i].split('\t');
        const zi=t[0], stroke=(t[1].match(/\d+/)||[''])[0];
        const vars=(t[6]||'').split('/');
        const canon=vars[0]||'';
        const leaf=t[13]||'';
        vars.forEach(v=>radicalMap.set(v,canon));
        ziDB.set(zi,{stroke,radical:canon,leaf});
      }
      refresh();
    });

    /* ===== 2. DOM ===== */
    const listbox=document.getElementById('listbox');
    const guessbox=document.getElementById('guess');
    const output=document.getElementById('output');
    const sortOpt=document.getElementById('sort');
    const showLeaf=document.getElementById('showLeaf');
    const importBox=document.getElementById('importBox');

    /* ===== 3. å·¥å…· ===== */
    const hanRegex=/[\u4e00-\u9fff]/;
    function strokeGuessed(stroke,numStrings){return numStrings.some(s=>s.includes(stroke));}
    function syncImportBox(){
      const lines=[], names=[...listbox.querySelectorAll('.name')];
      names.forEach((inp,i)=>{const v=inp.value.trim();if(v)lines.push(`${i+1}. ${v}`);});
      importBox.value=lines.join('\n');
    }
    function filterTitle(title,limit){
      switch(limit){
        case 'letters':  return /^[A-Za-z\s]+$/.test(title);
        case 'hanOnly':  return /^[\u4e00-\u9fff]+$/.test(title);
        case 'noHan':    return !hanRegex.test(title);
        case 'noSymbol': return !/[^\u4e00-\u9fffA-Za-z\u3040-\u30ff0-9\s]/.test(title);
        default: return true;
      }
    }

    /* ===== 4. çŠ¶æ€ç¼“å­˜ ===== */
    function saveState(){
      const state={
        songs:[...listbox.querySelectorAll('.song-row')].map(row=>({
          name:row.querySelector('.name').value,
          show:row.querySelector('.show-cbx').checked
        })),
        guess:guessbox.value,
        sort:sortOpt.checked,
        showLeaf:showLeaf.checked
      };
      localStorage.guessSongState=JSON.stringify(state);
    }
    function loadState(){
      const saved=localStorage.guessSongState;
      if(saved){
        try{
          const st=JSON.parse(saved);
          listbox.innerHTML='';
          (st.songs||[]).forEach(s=>add(s.name,s.show));
          guessbox.value=st.guess||'';
          sortOpt.checked=!!st.sort;
          showLeaf.checked=!!st.showLeaf;
        }catch(e){console.error('loadState error',e);}
      }
      refresh();
    }

    /* ===== 5. åˆ·æ–° ===== */
    function refresh(){
      if (sortOpt.checked) guessbox.value = [...new Set([...guessbox.value].filter(c => !/\d/.test(c)).sort())].join('') + guessbox.value.replace(/[^0-9]/g, '');
      const raw=guessbox.value;
      const charSet=new Set(raw.split(''));
      const numStrs=Array.from(raw.match(/\d+/g)||[]);
      const guessedRad=new Set([...charSet].filter(c=>radicalMap.has(c)).map(c=>radicalMap.get(c)));

      /* 5.1 ç»Ÿè®¡å‰©ä½™éƒ¨é¦–/éƒ¨ä»¶ & æ‰€æœ‰ç¬”ç”» */
      const remRad=new Set(), remLeaf=new Set(), allStroke=new Set(), guessedStroke=new Set();
      listbox.querySelectorAll('.song-row').forEach(row=>{
        const name=row.querySelector('.name').value;
        for(const ch of name){
          const rec=ziDB.get(ch); if(!rec) continue;
          allStroke.add(rec.stroke);
          const opened = charSet.has(ch);
          if(!opened){
            remRad.add(rec.radical);
            rec.leaf.split('/').forEach(l=>l&&remLeaf.add(l));
          }else{
            guessedStroke.add(rec.stroke);
          }
          if(strokeGuessed(rec.stroke,numStrs)) guessedStroke.add(rec.stroke);
        }
      });
      guessedRad.forEach(r=>remRad.delete(r));
      remLeaf.forEach(l=>{if(charSet.has(l))remLeaf.delete(l);});

      /* 5.2 gussed åˆ—è¡¨ï¼ˆå­—ç¬¦+å¤šä½ç¬”ç”»ï¼‰ */
      const gussedArr=[...new Set(raw.split(''))];
      guessedStroke.forEach(st=>{if(!gussedArr.includes(st))gussedArr.push(st);});

      /* 5.3 è¾“å‡ºå¤´éƒ¨ */
      let out='å‰©ä½™éƒ¨é¦–: '+[...remRad].join('')+'\n';
      if(showLeaf.checked) out+='å‰©ä½™éƒ¨ä»¶: '+[...remLeaf].join('')+'\n';
      out+='gussed: '+gussedArr.join(',')+'\n';

      /* 5.4 æ¯é¦–æ­Œ */
      let idx=0;
      listbox.querySelectorAll('.song-row').forEach(row=>{
        const showInfo=row.querySelector('.show-cbx').checked;
        const name=row.querySelector('.name').value;
        if(!name) return;
        idx++;
        let line=idx+'. ';
        for(const ch of name){
          const rec=ziDB.get(ch);
          const guessed=charSet.has(ch);
          if(rec){
            if(guessed){
              line+=ch+'';
            }else{
              const st=strokeGuessed(rec.stroke,numStrs)||showInfo?rec.stroke:'*';
              const rd=guessedRad.has(rec.radical)||showInfo?rec.radical:'*';
              const lf=rec.leaf.split('').map(c=>c==='/'?'/':((charSet.has(c)||showInfo)?c:'*')).join('');
              line+=(showInfo?ch:'*')+`(${st},${rd},${lf})`;
            }
          }else{
            line+=(guessed||showInfo?ch:'*')+'';
          }
        }
        out+=line.trimEnd()+'\n';
      });
      out+='æ ¼å¼è¯´æ˜ï¼š*åŒ…æ‹¬ç©ºæ ¼,æ‹¬å·ç­‰ç¬¦å·\næœªå¼€å‡ºçš„æ±‰å­—æ˜¾ç¤ºä¸º *(ç¬”ç”»,éƒ¨é¦–,éƒ¨ä»¶)\nå¦‚ã€Œå–µã€æ˜¾ç¤ºä¸º å–µ(11,å£,å£/è‰¹/ç”°)';
      output.textContent=out;
      syncImportBox();
      saveState();
    }

    /* ===== 6. æ­Œæ›²è¡Œ ===== */
    function add(name='',show=false){
      const row=document.createElement('div');
      row.className='song-row';
      row.innerHTML=`
        <label><input type="checkbox" class="show-cbx"${show?' checked':''} onchange="refresh()">Show</label>
        <input class="name" type="text" placeholder="æ­Œæ›²å" value="${name}" oninput="refresh()">
        <button onclick="this.parentNode.remove();refresh()">Ã—</button>`;
      listbox.appendChild(row);
      refresh();
    }
    function selectAll(){listbox.querySelectorAll('.show-cbx').forEach(cb=>cb.checked=!cb.checked);refresh();}
    function sort_by_length(){
      [...listbox.children].sort((a,b)=>a.querySelector('.name').value.length-b.querySelector('.name').value.length)
        .forEach(r=>listbox.appendChild(r));
      refresh();
    }
    function import_from_text(){
      listbox.innerHTML='';
      importBox.value.split('\n').forEach(l=>{const m=l.match(/^\s*\d+\.\s*(.+)$/);if(m)add(m[1].trim());});
      refresh();
    }

    /* ===== 7. éšæœºæ­Œæ›² ===== */
    async function addRandomSongs(){
      const limit=document.getElementById('limitType').value;
      const count=parseInt(document.getElementById('randomCount').value)||10;
      const ranges=[...document.querySelectorAll('.range-cbx:checked')].map(cb=>cb.value);
      if(!ranges.length){alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ­Œæ›²èŒƒå›´');return;}
      try{
        let pool=[];
        for(const range of ranges){
          const txt=await fetch(`./${range}.txt`).then(r=>r.text());
          pool.push(...txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean));
        }
        const available=pool.filter(t=>filterTitle(t,limit));
        if(!available.length){alert('ç¬¦åˆæ¡ä»¶çš„æ­Œæ›²ä¸ºç©º');return;}
        const chosen=new Set();
        while(chosen.size<count && chosen.size<available.length){
          const pick=available[Math.floor(Math.random()*available.length)];
          if(![...listbox.querySelectorAll('.name')].some(i=>i.value.trim()===pick)) chosen.add(pick);
        }
        chosen.forEach(t=>add(t));
      }catch(e){alert('è¯»å–æ­Œæ›²æ–‡ä»¶å¤±è´¥');console.error(e);}
    }

    /* ===== 8. ä¸»é¢˜åˆ‡æ¢ ===== */
    function initTheme(){const s=localStorage.theme;if(s==='light'||s==='dark')document.documentElement.className=s;updateThemeIcon();}
    function toggleTheme(){document.documentElement.className=document.documentElement.className==='dark'?'light':'dark';localStorage.theme=document.documentElement.className;updateThemeIcon();}
    function updateThemeIcon(){document.querySelector('.theme-toggle').textContent=document.documentElement.className==='dark'?'â˜€ï¸':'ğŸŒ™';}
    initTheme();

    /* ===== 9. ç»‘å®š ===== */
    guessbox.oninput=refresh;
    document.addEventListener('DOMContentLoaded',loadState);
    function toClipboard(){navigator.clipboard.writeText(output.textContent);}
  </script>
</body>
</html>