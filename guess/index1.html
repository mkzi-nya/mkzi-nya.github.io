<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>音游开字母 & 古诗文背默 工具</title>
  <style>
    :root{--bg:#fff;--fg:#000;--card:#f7f7f7;--input-bg:#fff;--input-fg:#000;--accent:#3498db;}
    @media(prefers-color-scheme:dark){
      :root{--bg:#121212;--fg:#e0e0e0;--card:#1e1e1e;--input-bg:#2a2a2a;--input-fg:#e0e0e0;--accent:#5dade2;}
    }
    html.light{--bg:#fff!important;--fg:#000!important;--card:#f7f7f7!important;--input-bg:#fff!important;--input-fg:#000!important}
    html.dark {--bg:#121212!important;--fg:#e0e0e0!important;--card:#1e1e1e!important;--input-bg:#2a2a2a!important;--input-fg:#e0e0e0!important}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Arial,Helvetica,sans-serif;line-height:1.5;overflow-x:hidden}
    h1{margin:16px 16px 8px;font-size:1.4rem}
    h2{margin:16px;font-size:1.1rem}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:14px;cursor:pointer}
    button:hover{opacity:.9}
    select{padding:6px;border-radius:4px}
    .container{padding:0 16px 32px}
    .card{background:var(--card);padding:12px;border-radius:8px;margin:8px 0}
    input[type=text],textarea{background:var(--input-bg);color:var(--input-fg);border:1px solid #ccc;border-radius:4px;padding:6px;width:80%;max-width:400px;margin:4px 0}
    textarea{height:120px;resize:vertical}
    pre{white-space:pre-wrap;word-break:break-all;background:var(--input-bg);padding:8px;border-radius:6px;max-height:320px;overflow-y:auto}
    /* —— 修复后的 .song-row 样式 —— */
    .song-row{display:flex;align-items:center;margin-bottom:4px}
    .song-row input[type=text]{flex:1;margin:0 6px}
    .row-no{width:28px;text-align:right;margin-right:4px}
    @media(max-width:600px){input[type=text],textarea{width:90%}}
    .theme-toggle{position:fixed;top:10px;right:14px;font-size:20px;background:none;border:none;color:var(--fg)}
    #infoBar{margin:20px 0;padding:8px;text-align:center;font-size:12px;color:var(--fg)}
    #answerList label{margin-right:16px;user-select:none}
    #answerList input[type=checkbox]{margin-right:4px}
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">🌙</button>

  <div class="container">
    <h1>音游开字母 & 古诗文背默 工具</h1>

    <h2 id="songListTitle">歌曲列表</h2>
    <div id="listbox" class="card"></div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <button onclick="add()">＋ 添加</button>
      <button onclick="sort_by_length()">按长度排序</button>
      <button onclick="selectAll()">全选/反选</button>
    </div>

    <h2>猜测输入</h2>
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
      <label>模式:</label>
      <label><input type="radio" name="mode" value="classic" onchange="switchMode()"> 传统</label>
      <label><input type="radio" name="mode" value="han" checked onchange="switchMode()"> 汉字解析</label>
      <label><input type="radio" name="mode" value="poetry" onchange="switchMode()"> 古诗文背默</label>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px">
      <label>guess:</label>
      <input id="guess" type="text" placeholder="输入字符">
      <label><input id="sort" type="checkbox" onchange="refresh()"> 自动排序</label>
      <label id="compLabel" style="display:inline-flex"><input id="showComp" type="checkbox" onchange="refresh()"> 显示剩余部件</label>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px">
      <label>不解析的字符:</label>
      <input id="skipChars" type="text" placeholder="将直接显示该字符">
    </div>
    <div style="margin-top:8px">
      <label>提示语:</label>
      <input id="hintText" type="text" placeholder="将出现在output的末尾" oninput="refresh()">
    </div>

    <div id="pinyinRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px">
      <label><input id="enablePinyin" type="checkbox" onchange="togglePinyin()"> 拼音解析</label>
      <input id="pinyinGuess" type="text" placeholder="输入拼音,逗号分隔" style="display:none">
    </div>

    <h2>输出结果 <button onclick="toClipboard()">复制</button></h2>
    <div class="card"><pre id="output"></pre></div>

    <div id="answerSection" style="display:none">
      <h2>答案列表</h2>
      <div id="answerList" class="card" style="overflow-x:auto;white-space:nowrap"></div>
    </div>

    <h2>批量导入 / 导出</h2>
    <div class="card" style="display:flex;flex-wrap:wrap;gap:16px">
      <div style="flex:1 1 300px">
        <textarea id="importBox" placeholder="1. 歌曲名 / 题目……"></textarea><br>
        <button onclick="import_from_text()">导入 (覆盖)</button>
      </div>
      <div id="songRangeBox" style="display:flex;flex-direction:column;gap:8px">
        <fieldset style="border:none;padding:0">
          <legend style="font-weight:bold">歌曲范围</legend>
          <label><input type="checkbox" class="range-cbx" value="phigros"> phigros</label><br>
          <label><input type="checkbox" class="range-cbx" value="arcaea"> arcaea</label><br>
          <label><input type="checkbox" class="range-cbx" value="milthm"> milthm</label><br>
          <label><input type="checkbox" class="range-cbx" value="notanote"> notanote</label><br>
          <label><input type="checkbox" class="range-cbx" value="cytus2"> cytus2</label><br>
          <label><input type="checkbox" class="range-cbx" value="pjsk"> プロセカ</label><br>
          <label><input type="checkbox" class="range-cbx" value="maimai"> maimai</label><br>
          <label><input type="checkbox" class="range-cbx" value="chunithm"> chunithm</label><br>
          <label><input type="checkbox" class="range-cbx" value="orzmic"> orzmic</label><br>
          <label><input type="checkbox" class="range-cbx" value="lanota"> lanota</label><br>
          <label><input type="checkbox" class="range-cbx" value="rotaeno"> rataeno</label><br>
          <label><input type="checkbox" class="range-cbx" value="rizline"> rizline</label><br>
          <label><input type="checkbox" class="range-cbx" value="muse dash"> muse dash</label><br>
          <label><input type="checkbox" class="range-cbx" value="Paradigm"> Paradigm : Reboot</label><br>
          <label><input type="checkbox" class="range-cbx" value="awa"> awa…?</label><br>
          <label><input type="checkbox" class="range-cbx" value="milthm1"> milthm曲/谱师</label>
        </fieldset>
        <label id="limitLabel">限制
          <select id="limitType">
            <option value="none">无</option>
            <option value="letters">只包含字母</option>
            <option value="hanOnly">只包含汉字</option>
            <option value="hasHan">包含汉字</option>
            <option value="noHan">不包含汉字</option>
            <option value="japaneseOnly">只包含日文</option>
            <option value="japaneseHanOnly">只包含日文与汉字</option>
            <option value="noSymbol">不包含符号</option>
            <option value="hasSymbol">包含符号</option>
            <option value="symbolOnly">只包含符号</option>
          </select>
        </label>
        <label>数量 <input id="randomCount" type="number" min="1" value="10" style="width:60px"></label>
        <button onclick="addRandomSelection()">随机选择</button>
      </div>

      <div id="poetryRangeSelection" style="display:none;flex-direction:column;gap:8px">
        <fieldset style="border:none;padding:0">
          <legend style="font-weight:bold">题目范围</legend>
          <label><input type="radio" name="poetryRange" value="all" checked> 综合</label><br>
          <label><input type="radio" name="poetryRange" value="regular"> 常规</label><br>
          <label><input type="radio" name="poetryRange" value="comprehension"> 理解性默写</label>
        </fieldset>
        <label>数量 <input id="randomCountPoetry" type="number" min="1" value="10" style="width:60px"></label>
        <button onclick="addRandomSelection()">随机选题</button>
      </div>
    </div>
  </div>

  <div id="infoBar"></div>

  <script>
  /* —— 辅助：转义 & 替换第 N 次 —— */
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function replaceNth(str, find, replaceText, n){
    let i=0;
    return str.replace(new RegExp(escapeRegExp(find),'g'), m=>++i===n?replaceText:m);
  }

  /* —— 多模式存储隔离 —— */
  function storageKey(m){ return m==='poetry'?'guessPoetryState':'guessSongState'; }
  function defaultSkip(m){ return m==='poetry'?' []':''; }
  let currentMode='han';

  function saveStateFor(mode){
    if(!mode) return;
    const key=storageKey(mode);
    const st={
      songs:[...listbox.querySelectorAll('.song-row')].map(r=>({
        idx:r.dataset.no,
        name:r.querySelector('.name').value,
        show:r.querySelector('.show-cbx')?.checked,
        hide:r.querySelector('.hide-cbx')?.checked,
        type:r.dataset.type,
        answers:r.dataset.answers||null
      })),
      guess:guessbox.value,
      sort:sortOpt.checked,
      showComp:showComp.checked,
      pinyinEnable:enablePinyin.checked,
      pinyinGuess:pinyinGuessBox.value,
      skipChars:skipCharsBox.value,
      hint:document.getElementById('hintText').value,
      compOrder, ansSelect:ansSelectionMap
    };
    localStorage.setItem(key,JSON.stringify(st));
  }

  function loadStateFor(mode){
    const key=storageKey(mode), str=localStorage.getItem(key);
    listbox.innerHTML=''; songCounter=0; compOrder=[]; ansSelectionMap={};
    if(str){
      try{
        const st=JSON.parse(str);
        st.songs.forEach(o=>add(o.name, o.show, o.hide, parseInt(o.idx), o.type, o.answers?JSON.parse(o.answers):null));
        guessbox.value=st.guess||'';
        sortOpt.checked=st.sort;
        showComp.checked=st.showComp;
        enablePinyin.checked=st.pinyinEnable;
        pinyinGuessBox.value=st.pinyinGuess||'';
        skipCharsBox.value = ('skipChars' in st)?st.skipChars:defaultSkip(mode);
        document.getElementById('hintText').value=st.hint||'';
        compOrder=st.compOrder||[];
        ansSelectionMap=st.ansSelect||{};
      }catch(e){console.error(e);}
    } else {
      guessbox.value=''; sortOpt.checked=false; showComp.checked=false;
      enablePinyin.checked=false; pinyinGuessBox.value='';
      skipCharsBox.value=defaultSkip(mode);
      document.getElementById('hintText').value='';
    }
    refresh();
  }

  function saveState(){ saveStateFor(currentMode); localStorage.setItem('guessMode', currentMode);
}

  function switchMode(){
    saveStateFor(currentMode);
    currentMode = getMode();
    const isP = currentMode==='poetry';
    pinyinRow.style.display = currentMode!=='classic'?'flex':'none';
    document.getElementById('compLabel').style.display = currentMode!=='classic'?'inline-flex':'none';
    songListTitle.textContent = isP?'题目列表':'歌曲列表';
    songRangeBox.style.display = isP?'none':'flex';
    limitLabel.style.display   = isP?'none':'inline-block';
    poetryRangeSelection.style.display = isP?'flex':'none';
    if(skipCharsBox.value.trim()===''||skipCharsBox.value===defaultSkip(isP?'han':'poetry')){
      skipCharsBox.value=defaultSkip(currentMode);
    }
    loadStateFor(currentMode);
    if(!isP) answerSection.style.display='none';
  }

  /* —— 题库加载 —— */
  let poetryRegular=[], poetryComprehension=[];
  Promise.all([
    fetch('https://reciter.binkic.com/normal/poems.json').then(r=>r.json()).then(j=>processNormal(j.poems||[])),
    fetch('https://reciter.binkic.com/universal/universal.json').then(r=>r.json()).then(j=>processUniversal(j.repositories||[])),
    fetch('https://reciter.binkic.com/comprehensions/comprehensions.json').then(r=>r.json()).then(j=>{
      (j.comprehensions||[]).forEach(o=>poetryComprehension.push(o));
    })
  ]).catch(console.error);

  function processNormal(arr){
    arr.forEach(poem=>{
      poem.content.forEach(line=>{
        const phrase=line.map(u=>Array.isArray(u)?u.join('/') : u).join('');
        poetryRegular.push({content:phrase});
      });
    });
  }
  function processUniversal(arr){
    arr.forEach(rep=>{
      (rep.normal||[]).forEach(line=>{
        const phrase=line.map(u=>Array.isArray(u)?u.join('/') : u).join('');
        poetryRegular.push({content:phrase});
      });
      (rep.comprehensions||[]).forEach(c=>poetryComprehension.push(c));
    });
  }

  /* —— 部件 & 拼音 数据加载 —— */
  const charPinyinExt=new Map();
  const strokeMap=new Map(), variantMap=new Map();
  const decompJT=new Map(), decompFT=new Map(), charPinyin=new Map();
  let decompLoaded=0;

  fetch('./zi.tsv').then(r=>r.text()).then(t=>{
    t.trim().split(/\r?\n/).slice(1).forEach(l=>{
      const [c,s]=l.split('\t'), st=(s.match(/\d+/)||[''])[0];
      if(c&&st) strokeMap.set(c,st);
    });
    refresh();
  });

  fetch('./chaizi-master/fanjian_suoyin.txt').then(r=>r.text()).then(t=>{
    t.trim().split(/\r?\n/).forEach(l=>{
      const [v,c]=l.split('\t');
      if(v&&c) variantMap.set(v,c);
    });
    refresh();
  });

  function loadChaizi(txt,map){
    txt.trim().split(/\r?\n/).forEach(l=>{
      const arr=l.split('\t'), ch=arr.shift();
      if(!ch) return;
      const schemes=arr.map(p=>p.trim().split(/\s+/).filter(Boolean));
      if(schemes.length) map.set(ch,schemes);
    });
    decompLoaded++;
    if(decompLoaded===2) buildGlobalEquiv();
    refresh();
  }
  fetch('./chaizi-master/chaizi-jt.txt').then(r=>r.text()).then(t=>loadChaizi(t,decompJT));
  fetch('./chaizi-master/chaizi-ft.txt').then(r=>r.text()).then(t=>loadChaizi(t,decompFT));

  function removeTone(p){
    const m={'ā':'a','á':'a','ǎ':'a','à':'a','ē':'e','é':'e','ě':'e','è':'e','ī':'i','í':'i','ǐ':'i','ì':'i',
             'ō':'o','ó':'o','ǒ':'o','ò':'o','ū':'u','ú':'u','ǔ':'u','ù':'u','ǖ':'v','ǘ':'v','ǚ':'v','ǜ':'v',
             'ü':'v','ń':'n','ň':'n'};
    return p.replace(/[āáǎàēéěèīíǐìōóǒòūúǔùǖǘǚǜüńň]/g,c=>m[c]||c);
  }

  fetch('./pinyin.txt').then(r=>r.text()).then(text=>{
    text.split('\n').forEach(line=>{
      if(line.startsWith('#')) return;
      const match=line.match(/^U\+([0-9A-F]{4,6}):\s*([\w,üǎěǐǒūńň]+).*#\s*(.)/iu);
      if(match){
        const cp=parseInt(match[1],16),
              ch=String.fromCodePoint(cp),
              raw=match[2].split(',')[0],
              py=removeTone(raw.toLowerCase());
        charPinyinExt.set(ch,py);
      }
    });
    refresh();
  });

  function getPinyin(ch){
    if(charPinyin.has(ch)) return charPinyin.get(ch);
    if(charPinyinExt.has(ch)){
      const py=charPinyinExt.get(ch);
      charPinyin.set(ch,py);
      return py;
    }
    return '';
  }

  /* —— 部件等价表 —— */
  const compEquiv=new Map();
  function addEquiv(a,b){
    if(!compEquiv.has(a)) compEquiv.set(a,new Set());
    if(!compEquiv.has(b)) compEquiv.set(b,new Set());
    compEquiv.get(a).add(b);
    compEquiv.get(b).add(a);
  }
  function buildGlobalEquiv(){
    [decompJT,decompFT].forEach(mp=>{
      mp.forEach(scs=>{
        const len=scs[0].length;
        for(let k=1;k<scs.length;k++){
          if(scs[k].length!==len) continue;
          for(let i=0;i<len;i++){
            const a=scs[0][i], b=scs[k][i];
            if(a!==b) addEquiv(a,b);
          }
        }
      });
    });
  }

  /* —— 工具函数 —— */
  const hanRegex=/[\u4e00-\u9fff]/;
  const initList=['zh','ch','sh','b','p','m','f','d','t','n','l','g','k','h','j','q','x','r','z','c','s','y','w'];

  function canonicalize(c){ return variantMap.get(c)||c; }
  function normalizeChar(c){
    return /[A-Za-z]/.test(c) ? c.toLowerCase() : canonicalize(c);
  }
  function strokeGuessed(st,nums){ return nums.some(s=>s.includes(st)); }

  function splitInitialFinal(py){
    let init='', final=py;
    for(const i of initList) if(py.startsWith(i)){ init=i; final=py.slice(i.length); break; }
    return {init, final};
  }
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }

  function getDecomps(ch){
    if(decompJT.has(ch)) return decompJT.get(ch);
    if(decompFT.has(ch)) return decompFT.get(ch);
    const can=canonicalize(ch);
    if(can!==ch){
      if(decompJT.has(can)) return decompJT.get(can);
      if(decompFT.has(can)) return decompFT.get(can);
    }
    return null;
  }

  const preferSet=new Set(['艹','氵','冫','月','灬','覀']);
  function defaultComponents(ch){
    const ds=getDecomps(ch);
    if(!ds||!ds.length) return [];
    const len=ds[0].length, ret=[];
    for(let i=0;i<len;i++){
      const cands=[ds[0][i]];
      ds.slice(1).forEach(s=> s.length===len && cands.push(s[i]));
      let best=cands[0], st=strokeMap.get(best)||99;
      if(cands.some(c=>preferSet.has(c))) best=cands.find(c=>preferSet.has(c));
      else cands.forEach(c=>{
        const s2=strokeMap.get(c)||99;
        if(s2<st||(s2===st&&c.charCodeAt(0)<best.charCodeAt(0))){
          best=c; st=s2;
        }
      });
      ret.push(best);
    }
    return ret;
  }

  /* —— DOM 引用 & 状态 —— */
  const listbox       = document.getElementById('listbox'),
        guessbox      = document.getElementById('guess'),
        output        = document.getElementById('output'),
        sortOpt       = document.getElementById('sort'),
        showComp      = document.getElementById('showComp'),
        importBox     = document.getElementById('importBox'),
        enablePinyin  = document.getElementById('enablePinyin'),
        pinyinGuessBox= document.getElementById('pinyinGuess'),
        skipCharsBox  = document.getElementById('skipChars'),
        pinyinRow     = document.getElementById('pinyinRow'),
        songListTitle = document.getElementById('songListTitle'),
        songRangeBox  = document.getElementById('songRangeBox'),
        poetryRangeSelection = document.getElementById('poetryRangeSelection'),
        limitLabel    = document.getElementById('limitLabel'),
        answerSection = document.getElementById('answerSection'),
        answerListDiv = document.getElementById('answerList');

  let compOrder=[], songCounter=0, ansSelectionMap={};

  function getMode(){ return document.querySelector('input[name="mode"]:checked').value; }
  function togglePinyin(){ pinyinGuessBox.style.display = enablePinyin.checked ? 'inline-block' : 'none'; refresh(); }
  function updateRowNumbers(){ [...listbox.children].forEach((r,i)=>r.querySelector('.row-no').textContent=(i+1)+'.'); }

  /* —— 核心解析 ========== */
function parseLineHan(name, canonSet, numStrs, skipSet, pinyinActive, pySet, showInfo){
  const remainingComp = new Set(), guessedStroke = new Set();
  let line = '', insideLiteral = false;

  for (let i = 0; i < name.length; i++) {
    const ch = name[i];

    // 检测 [明文答案] 区域，不参与解析
    if (ch === '[') {
      insideLiteral = true;
      line += ch;
      continue;
    }
    if (ch === ']') {
      insideLiteral = false;
      line += ch;
      continue;
    }
    if (insideLiteral) {
      line += ch;
      continue;
    }

    const canon = normalizeChar(ch),
          isHan = hanRegex.test(ch),
          stroke = strokeMap.get(ch) || '',
          chGuessed = canonSet.has(canon);

    if (skipSet.has(ch)) { line += ch; continue; }

    if (isHan){
      const comps = defaultComponents(ch),
            pyRaw = getPinyin(ch) || '';
      let pyDisp = '', hasPy = false;
      if (pinyinActive && pyRaw){
        const {init,final} = splitInitialFinal(pyRaw),
              iG = pySet.has(init), fG = pySet.has(final);
        hasPy = true;
        if (showInfo) pyDisp = pyRaw;
        else if (init){
          if (iG && fG) pyDisp = pyRaw;
          else if (iG) pyDisp = init + '-';
          else if (fG) pyDisp = '-' + final;
          else pyDisp = '--';
        } else pyDisp = fG ? final : '--';
      }
      if (chGuessed){
        line += ch;
        if (stroke) guessedStroke.add(stroke);
      } else {
        comps.forEach(c => !canonSet.has(normalizeChar(c)) && remainingComp.add(c));
        if (stroke && strokeGuessed(stroke, numStrs)) guessedStroke.add(stroke);
        const compShow = comps.map(c => canonSet.has(normalizeChar(c)) || showInfo ? c : '-').join('/'),
              stShow = stroke && (strokeGuessed(stroke, numStrs) || showInfo) ? stroke : '-';
        if (hasPy) line += (showInfo ? ch : '*') + `(${pyDisp || '-'},${stShow},${compShow})`;
        else       line += (showInfo ? ch : '*') + `(${stShow},${compShow})`;
      }
    } else {
      line += (chGuessed || showInfo) ? ch : '*';
    }
  }

  return { line, remainingComp, guessedStroke };
}


  /* —— 刷新：非诗模式 —— */
  function refreshNonPoetry(){
    const mode=getMode();
    if(sortOpt.checked){
      if(mode==='han'){
        guessbox.value=[...new Set([...guessbox.value].filter(c=>!/\d/.test(c))
          .map(c=>/[A-Za-z]/.test(c)?c.toLowerCase():c)
          .sort())].join('') + guessbox.value.replace(/[^0-9]/g,'');
      } else {
        guessbox.value=[...new Set([...guessbox.value]
          .map(c=>/[A-Za-z]/.test(c)?c.toLowerCase():c)
          .sort())].join('');
      }
    }
    const raw=[...guessbox.value].map(c=>/[A-Za-z]/.test(c)?c.toLowerCase():c),
          canonSet=new Set(raw.map(c=>normalizeChar(c))),
          numStrs=[...guessbox.value.match(/\d+/g)||[]],
          pinyinActive=(mode!=='classic'&&enablePinyin.checked),
          pySegs=pinyinActive?pinyinGuessBox.value.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean):[],
          pySet=new Set(pySegs),
          skipSet=new Set(skipCharsBox.value.split('')),
          remainingComp=new Set(), guessedStroke=new Set(),
          outLines=[];

    listbox.querySelectorAll('.song-row').forEach(row=>{
      const hide=row.querySelector('.hide-cbx').checked,
            showInfo=row.querySelector('.show-cbx').checked,
            name=row.querySelector('.name').value,
            no=row.querySelector('.row-no').textContent.trim();
      if(!name||hide){ outLines.push(null); return; }
      const p=parseLineHan(name,canonSet,numStrs,skipSet,pinyinActive,pySet,showInfo);
      p.remainingComp.forEach(c=>remainingComp.add(c));
      p.guessedStroke.forEach(s=>guessedStroke.add(s));
      outLines.push(no+' '+p.line);
    });

    const guessedArr=[...new Set(raw)];
    guessedStroke.forEach(s=>!guessedArr.includes(s)&&guessedArr.push(s));
    let header='guessed: '+guessedArr.join(',')+'\n';
    if(pinyinActive) header+='pinyin: '+pySegs.join(',')+'\n';
    if(compOrder.length===0) compOrder=[...remainingComp], shuffle(compOrder);
    else remainingComp.forEach(c=>!compOrder.includes(c)&&compOrder.push(c)),
         compOrder=compOrder.filter(c=>remainingComp.has(c));
    if(showComp.checked) header+='剩余部件: '+compOrder.join('')+'\n';

    const hint=document.getElementById('hintText').value.trim(),
          explain=pinyinActive
            ? '\n格式说明：未开出的汉字显示为 *(拼音/笔画数/部件)\n拼音格式：声+韵，如双sh-/-uang'
            : mode!=='classic'
              ? '\n格式说明：未开出的汉字显示为 *(笔画数/部件)'
              : '';

    output.textContent = header + outLines.filter(l=>l!==null).join('\n') + explain + (hint?'\n'+hint:'');
    syncImportBox();
    updateRowNumbers();
    saveState();
  }

  /* —— 刷新：古诗模式 —— */
  function refreshPoetry(){
    const raw=[...guessbox.value].map(c=>/[A-Za-z]/.test(c)?c.toLowerCase():c),
          canonSet=new Set(raw.map(c=>normalizeChar(c))),
          numStrs=[...guessbox.value.match(/\d+/g)||[]],
          pinyinActive=enablePinyin.checked,
          pySegs=pinyinActive?pinyinGuessBox.value.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean):[],
          pySet=new Set(pySegs),
          skipSet=new Set(skipCharsBox.value.split(''));

    let remainingComp=new Set(), guessedStroke=new Set(),
        outLines=[], answerHTML=[], needAnswer=false;

    listbox.querySelectorAll('.song-row').forEach(row=>{
      const idx=row.dataset.no,
            hide=row.querySelector('.hide-cbx').checked,
            showQ=row.querySelector('.show-cbx').checked,
            type=row.dataset.type||'normal',
            contentRaw=row.querySelector('.name').value;
      if(!contentRaw || hide) return;

if (showQ) {
  // 显示原题，但不带答案
  const display = type === 'comprehension'
    ? contentRaw.replace(/\$\d+/g, '[]')
    : contentRaw;
  outLines.push(`${idx}. ${display}`);
  return;
}

if (type !== 'comprehension') {
  // normal 类型照旧
  const p = parseLineHan(contentRaw, canonSet, numStrs, skipSet, pinyinActive, pySet, showQ);
  p.remainingComp.forEach(c => remainingComp.add(c));
  p.guessedStroke.forEach(s => guessedStroke.add(s));
  outLines.push(`${idx}. ${p.line}`);
} else {
  needAnswer = true;
  const ansArr = JSON.parse(row.dataset.answers || '[]');
  const checkedMap = ansSelectionMap[idx] || {};
  const allChecked = ansArr.every((_, i) => checkedMap[i]);

  let finalText = '';

  if (allChecked) {
    // 所有答案勾选，构造 [答案] 明文替换，无解析
    finalText = contentRaw.replace(/\$([0-9]+)/g, (_, n) => {
      const ans = ansArr[n];
      return '[' + (Array.isArray(ans) ? ans.join('/') : ans) + ']';
    });
    outLines.push(`${idx}. ${finalText}`);
  } else {
    // 部分/无勾选，替换勾选答案为 [答案]，未选为 []
    const replaced = contentRaw.replace(/\$([0-9]+)/g, (_, n) => {
      const i = parseInt(n);
      if (checkedMap[i]) {
        const ans = ansArr[i];
        return '[' + (Array.isArray(ans) ? ans.join('/') : ans) + ']';
      } else {
        return '[]';
      }
    });
    const p = parseLineHan(replaced, canonSet, numStrs, skipSet, pinyinActive, pySet, showQ);
    p.remainingComp.forEach(c => remainingComp.add(c));
    p.guessedStroke.forEach(s => guessedStroke.add(s));
    finalText = p.line;
    outLines.push(`${idx}. ${finalText}`);
  }

  // 构建答案勾选区
  let ansLine = `${idx}. `;
  ansArr.forEach((ans, ai) => {
    const disp = Array.isArray(ans) ? ans.join('/') : ans;
    const checked = !!checkedMap[ai];
    ansLine += `<label><input type="checkbox" class="ans-cbx" data-row="${idx}" data-idx="${ai}" ${checked ? 'checked' : ''}>${disp}</label>`;
    if (ai < ansArr.length - 1) ansLine += '，';
  });
  answerHTML.push(ansLine);
}

    });

    const guessedArr=[...new Set(raw)];
    guessedStroke.forEach(s=>!guessedArr.includes(s)&&guessedArr.push(s));
    let header='guessed: '+guessedArr.join(',')+'\n';
    if(pinyinActive) header+='pinyin: '+pySegs.join(',')+'\n';
    if(compOrder.length===0) compOrder=[...remainingComp], shuffle(compOrder);
    else remainingComp.forEach(c=>!compOrder.includes(c)&&compOrder.push(c)),
         compOrder=compOrder.filter(c=>remainingComp.has(c));
    if(showComp.checked) header+='剩余部件: '+compOrder.join('')+'\n';

    const hint=document.getElementById('hintText').value.trim(),
          explain=pinyinActive
            ? '\n格式说明：未开出的汉字显示为 *(拼音/笔画数/部件)\n拼音格式：声+韵，如双sh-/-uang'
            : '\n格式说明：未开出的汉字显示为 *(笔画数/部件)';

    output.textContent = header + outLines.join('\n') + explain + (hint?'\n'+hint:'');

    if(needAnswer){
      answerSection.style.display='block';
      answerListDiv.innerHTML=answerHTML.join('<br>');
    } else {
      answerSection.style.display='none';
      answerListDiv.innerHTML='';
    }

    if(!answerListDiv._binded){
      answerListDiv.addEventListener('change', e=>{
        if(e.target.classList.contains('ans-cbx')){
          const r=e.target.dataset.row, ix=e.target.dataset.idx;
          ansSelectionMap[r]=ansSelectionMap[r]||{};
          ansSelectionMap[r][ix]=e.target.checked;
          refreshPoetry();
        }
      });
      answerListDiv._binded=true;
    }

    syncImportBox();
    updateRowNumbers();
    saveState();
  }

  function refresh(){
    getMode()==='poetry'?refreshPoetry():refreshNonPoetry();
  }

  /* —— 行操作 —— */

function add(name = '', show = false, hide = false, fixedNo = null, type = 'normal', answers = null) {
  songCounter++;
  const no = fixedNo || songCounter;

  const row = document.createElement('div');
  row.className = 'song-row';
  row.dataset.no = no;
  row.dataset.type = type;
  if (answers) row.dataset.answers = JSON.stringify(answers);

  // 结构手动构建而非拼接 HTML 字符串
  row.innerHTML = `
    <span class="row-no">${no}.</span>
    <label><input type="checkbox" class="show-cbx"${show ? ' checked' : ''}>Show</label>
    <label><input type="checkbox" class="hide-cbx"${hide ? ' checked' : ''}>Hide</label>
    <button>×</button>
  `;

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'name';
  input.placeholder = getMode() === 'poetry' ? '题干' : '歌曲名';
  input.value = name; // ← 用 .value 安全赋值，不用转义
  input.oninput = refresh;

  const btn = row.querySelector('button');
  btn.onclick = () => { row.remove(); refresh(); };

  row.insertBefore(input, btn);
  listbox.appendChild(row);
}

  function syncShowHide(cb){
    const r=cb.closest('.song-row');
    if(cb.classList.contains('show-cbx')&&cb.checked) r.querySelector('.hide-cbx').checked=false;
    if(cb.classList.contains('hide-cbx')&&cb.checked) r.querySelector('.show-cbx').checked=false;
    refresh();
  }

  function selectAll(){
    listbox.querySelectorAll('.show-cbx').forEach(cb=>cb.checked=!cb.checked);
    refresh();
  }

  /* —— 修正后的排序 —— */
  function sort_by_length(){
    const rows=[...listbox.children];
    rows.sort((a,b)=>
      a.querySelector('.name').value.length - b.querySelector('.name').value.length
    );
    rows.forEach((r,i)=>{
      r.dataset.no=i+1;
      listbox.appendChild(r);
    });
    syncImportBox();
    updateRowNumbers();
    refresh();
  }

function import_from_text(){
  listbox.innerHTML = '';
  songCounter = 0;
  importBox.value.trim().split(/\r?\n/).map(l => l.trim()).filter(Boolean).forEach((line, idx) => {
    const n = line.match(/^\s*(\d+)\.\s*(.+)$/);
    if (!n) return;
    const no = parseInt(n[1]);
    let content = n[2];

    // 自动识别是否包含填空
    const matches = [...content.matchAll(/\[(.+?)\]/g)];
    if (matches.length > 0) {
      const ans = matches.map(x => x[1]);
      content = content.replace(/\[(.+?)\]/g, (_, m) => {
        const index = ans.findIndex(a => a === m);
        return `$${index}`;
      });
      add(content, false, false, no, 'comprehension', ans);
    } else {
      add(content, false, false, no);
    }
  });
  refresh();
}


function syncImportBox() {
  const lines = [...listbox.querySelectorAll('.song-row')].map((r, k) => {
    const raw = r.querySelector('.name').value;
    if (!raw) return '';
    if (r.dataset.type === 'comprehension') {
      const ans = JSON.parse(r.dataset.answers || '[]');
      let exp = raw;
      ans.forEach((a, i) => {
        const disp = Array.isArray(a) ? a.join('/') : a;
        exp = exp.replace(new RegExp('\\$' + i, 'g'), `[${disp}]`);
      });
      return `${k + 1}. ${exp}`;
    }
    return `${k + 1}. ${raw}`;
  }).filter(Boolean);

  importBox.value = lines.join('\n');
}


  function addRandomSelection(){
    getMode()==='poetry'?addRandomPoetry():addRandomSongs();
  }

  function filterTitle(title,limit){
    switch(limit){
      case'letters':return /^[A-Za-z\s]+$/.test(title);
      case'hanOnly':return /^[\u4e00-\u9fff]+$/.test(title);
      case'hasHan':return /[\u4e00-\u9fff]/.test(title);
      case'noHan':return !/[\u4e00-\u9fff]/.test(title);
      case'noSymbol':return !/[^\u4e00-\u9fffA-Za-z\u3040-\u30ff0-9\s]/.test(title);
      case'hasSymbol':return /[^A-Za-z\u4e00-\u9fff\u3040-\u30ff0-9\s]/.test(title);
      case'symbolOnly':return /^[^A-Za-z\u4e00-\u9fff\u3040-\u30ff0-9\s]+$/.test(title);
      case'japaneseOnly':return /^[\u3040-\u30ff\u31f0-\u31ff\uFF66-\uFF9F\u0020\u30fc]+$/.test(title);
      case'japaneseHanOnly':return /^[\u3040-\u30ff\u31f0-\u31ff\uFF66-\uFF9F\u0020\u30fc\u4e00-\u9fff]+$/.test(title);
      default: return true;
    }
  }

  async function addRandomSongs(){
    const limit=document.getElementById('limitType').value,
          count=parseInt(document.getElementById('randomCount').value)||10,
          ranges=[...document.querySelectorAll('.range-cbx:checked')].map(cb=>cb.value);
    if(!ranges.length){ alert('请至少选择一个歌曲范围'); return; }
    try{
      let pool=[];
      for(const r of ranges){
        const txt=await fetch(`./ck/${r}.txt`).then(e=>e.text());
        pool.push(...txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean));
      }
      pool=[...new Set(pool)].filter(Boolean);
      const available=pool.filter(t=>filterTitle(t,limit));
      if(!available.length){ alert('符合条件为空'); return; }
      const current=new Set([...listbox.querySelectorAll('.name')].map(i=>i.value.trim())),
            unused=available.filter(t=>!current.has(t));
      if(!unused.length){ alert('列表中已包含所有符合条件歌曲'); return; }
      shuffle(unused);
      unused.slice(0,Math.min(count,unused.length)).forEach(t=>add(t));
    }catch(e){ alert('读取歌曲文件失败'); console.error(e); }
    syncImportBox();

  }

function addRandomPoetry(){
  const range = document.querySelector('input[name="poetryRange"]:checked').value,
        cnt = parseInt(document.getElementById('randomCountPoetry').value) || 10;
  let pool = [];

  if (range === 'comprehension') pool = [...poetryComprehension];
  else if (range === 'regular') pool = poetryRegular.map(p => ({ content: p.content }));
  else pool = [...poetryRegular.map(p => ({ content: p.content })), ...poetryComprehension];

  if (!pool.length){ alert('题库为空'); return; }
  shuffle(pool);

  pool.slice(0, Math.min(cnt, pool.length)).forEach(q => {
    const content = q.content;
    const answers = q.answer;

    if (typeof content !== 'string') {
      console.warn('跳过非字符串内容：', q);
      return;
    }

    // 不要使用 .trim()，避免破坏转义符
    if (answers && /\$\d+/.test(content)) {
      add(content, false, false, null, 'comprehension', answers);
    } else {
      add(content, false, false, null, 'normal');
    }
  });

  syncImportBox();
}

  /* —— 主题 & 复制 —— */
  function initTheme(){
    const s=localStorage.theme;
    if(s==='light'||s==='dark') document.documentElement.className=s;
    updateIcon();
  }
  function toggleTheme(){
    document.documentElement.className = document.documentElement.className==='dark'?'light':'dark';
    localStorage.theme=document.documentElement.className;
    updateIcon();
  }
  function updateIcon(){
    document.querySelector('.theme-toggle').textContent = document.documentElement.className==='dark'?'☀️':'🌙';
  }
  function toClipboard(){ navigator.clipboard.writeText(output.textContent); }

// —— 启动 ——
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  guessbox.oninput = refresh;
  pinyinGuessBox.oninput = refresh;
  skipCharsBox.oninput = refresh;

  currentMode = localStorage.getItem('guessMode') || 'han';
  document.querySelector(`input[name="mode"][value="${currentMode}"]`).checked = true;
  switchMode();
});

  </script>
</body>
</html>
